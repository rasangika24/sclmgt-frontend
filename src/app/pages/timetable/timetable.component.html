<!-- src/app/pages/timetable/timetable.component.html -->
<div class="container">
  <h2>Timetable Management</h2>

  <!-- Teacher Selection Section -->
  <mat-card class="teacher-selection-card" style="margin-bottom: 20px;">
    <mat-card-header>
      <mat-card-title>Teacher Selection</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="teacher-selection-row" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <mat-form-field style="min-width: 300px;">
          <mat-label>Select Teacher</mat-label>
          <mat-select [formControl]="selectedTeacherControl">
            <mat-option value="">All Teachers</mat-option>
            <mat-option *ngFor="let teacher of teachers" [value]="teacher.teacherId">
              {{ teacher.fullName }} ({{ teacher.teacherId }})
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div *ngIf="selectedTeacher" class="selected-teacher-info" style="display: flex; align-items: center; gap: 10px;">
          <mat-chip-set>
            <mat-chip color="primary" selected>
              {{ selectedTeacher.fullName }}
            </mat-chip>
          </mat-chip-set>
          
          <!-- <button mat-stroked-button color="primary" (click)="viewWeeklyTimetable()">
            <mat-icon>calendar_view_week</mat-icon>
            Weekly View
          </button> -->
          
          <button mat-stroked-button color="accent" (click)="checkConflicts()">
            <mat-icon>warning</mat-icon>
            Check Conflicts
          </button>
          
          <button mat-icon-button color="warn" (click)="clearTeacherSelection()" matTooltip="Clear Selection">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>

      <!-- Teacher Details Section -->
      <div *ngIf="selectedTeacherDetails" class="teacher-details" style="margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
        <h4 style="margin: 0 0 15px 0; color: #1976d2;">Teacher Information</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <div>
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #666;">person</mat-icon>
            <strong>Full Name:</strong> {{ selectedTeacherDetails.fullName }}
          </div>
          <div>
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #666;">badge</mat-icon>
            <strong>Teacher ID:</strong> {{ selectedTeacherDetails.teacherId }}
          </div>
          <div>
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #666;">email</mat-icon>
            <strong>Email:</strong> {{ selectedTeacherDetails.email }}
          </div>
          <div>
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #666;">phone</mat-icon>
            <strong>Phone:</strong> {{ selectedTeacherDetails.phone }}
          </div>
          <div>
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #666;">school</mat-icon>
            <strong>Subject:</strong> {{ selectedTeacherDetails.subject }}
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Weekly Timetable View -->
  <div *ngIf="showWeeklyView && weeklyTimetableData" class="weekly-view-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
          <span>Weekly Timetable - {{ weeklyTimetableData.teacherName }}</span>
          <button mat-icon-button color="warn" (click)="closeWeeklyView()" matTooltip="Close Weekly View">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-title>
        <mat-card-subtitle>{{ weeklyTimetableData.academicYear }} - {{ weeklyTimetableData.term }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content style="padding: 20px;">
        <!-- Weekly Timetable Grid -->
        <div class="weekly-timetable-grid" style="overflow-x: auto;">
          <table class="timetable-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
            <thead>
              <tr style="background-color: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; min-width: 80px;">Period</th>
                <th *ngFor="let day of weekDays" style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; min-width: 150px;">
                  {{ day }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let period of periods">
                <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold; background-color: #f9f9f9;">
                  {{ period }}
                </td>
                <td *ngFor="let day of weekDays" 
                    style="border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: top; min-height: 60px; position: relative;"
                    [style.background-color]="getTimetableEntry(day, period) ? '#e8f5e8' : '#fff'">
                  
                  <!-- Timetable Entry Content -->
                  <div *ngIf="getTimetableEntry(day, period) as entry; else emptyCell" 
                       class="timetable-entry" 
                       style="cursor: pointer; padding: 4px;" 
                       (click)="editTimetableEntry(entry)">
                    <div style="font-weight: bold; font-size: 12px; color: #1976d2;">{{ entry.subject }}</div>
                    <div style="font-size: 11px; color: #666;">{{ entry.grade }}</div>
                    <div style="font-size: 10px; color: #888;">{{ entry.startTime }} - {{ entry.endTime }}</div>
                    <div style="font-size: 10px; color: #888;">{{ entry.classRoom }}</div>
                  </div>
                  
                  <!-- Empty Cell with Add Button -->
                  <ng-template #emptyCell>
                    <div class="empty-cell" style="display: flex; justify-content: center; align-items: center; height: 50px;">
                      <button mat-icon-button 
                              color="primary" 
                              (click)="addTimetableEntry(day, period)" 
                              matTooltip="Add Timetable Entry"
                              class="add-button-hover">
                        <mat-icon style="font-size: 16px;">add</mat-icon>
                      </button>
                    </div>
                  </ng-template>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Weekly View Actions -->
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
          <button mat-raised-button color="primary" (click)="addTimetableEntry()">
            <mat-icon>add</mat-icon> Add New Entry
          </button>
          <button mat-stroked-button color="accent" (click)="refreshData()">
            <mat-icon>refresh</mat-icon> Refresh
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="table-section" *ngIf="!showWeeklyView">
    <!-- Header with Add Button and Filter -->
    <mat-toolbar color="primary">
      <span>{{ selectedTeacher ? selectedTeacher.fullName + "'s Timetable" : "All Timetables" }}</span>
      <span class="spacer"></span>
      <button mat-raised-button color="accent" (click)="addTimetableEntry()">
        <mat-icon>add</mat-icon> Add Timetable Entry
      </button>
    </mat-toolbar>

    <div class="refresh-filter-section" style="padding: 16px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
      <div class="refresh-button">
        <button mat-icon-button color="primary" (click)="refreshData()" matTooltip="Refresh Data">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>

      <mat-form-field class="filter" style="min-width: 200px;">
        <mat-label>Search</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search timetables..." #input />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field style="min-width: 120px;">
        <mat-label>Day</mat-label>
        <mat-select [(value)]="filterOptions.day" (selectionChange)="applyDayFilter()">
          <mat-option value="">All Days</mat-option>
          <mat-option *ngFor="let day of daysOfWeek" [value]="day">{{ day }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field style="min-width: 120px;">
        <mat-label>Academic Year</mat-label>
        <mat-select [(value)]="filterOptions.academicYear">
          <mat-option *ngFor="let year of academicYears" [value]="year">{{ year }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field style="min-width: 100px;">
        <mat-label>Term</mat-label>
        <mat-select [(value)]="filterOptions.term">
          <mat-option *ngFor="let term of terms" [value]="term">{{ term }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Timetable Table -->
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
      
      <!-- Teacher Name Column -->
      <ng-container matColumnDef="teacherName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Teacher</th>
        <td mat-cell *matCellDef="let element">
          <div style="display: flex; flex-direction: column;">
            <span style="font-weight: 500;">{{ element.teacherName }}</span>
            <span style="font-size: 12px; color: rgba(0,0,0,0.6);">ID: {{ element.teacherId }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Day Column -->
      <ng-container matColumnDef="dayOfWeek">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Day</th>
        <td mat-cell *matCellDef="let element">
          <mat-chip color="primary" selected>{{ element.dayOfWeek }}</mat-chip>
        </td>
      </ng-container>

      <!-- Period Column -->
      <ng-container matColumnDef="periodNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Period</th>
        <td mat-cell *matCellDef="let element">
          <mat-chip color="accent" selected>{{ element.periodNumber }}</mat-chip>
        </td>
      </ng-container>

      <!-- Start Time Column -->
      <ng-container matColumnDef="startTime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Start Time</th>
        <td mat-cell *matCellDef="let element">{{ element.startTime }}</td>
      </ng-container>

      <!-- End Time Column -->
      <ng-container matColumnDef="endTime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>End Time</th>
        <td mat-cell *matCellDef="let element">{{ element.endTime }}</td>
      </ng-container>

      <!-- Subject Column -->
      <ng-container matColumnDef="subject">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Subject</th>
        <td mat-cell *matCellDef="let element">
          <span style="font-weight: 500; color: #1976d2;">{{ element.subject }}</span>
        </td>
      </ng-container>

      <!-- Grade Column -->
      <ng-container matColumnDef="grade">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Grade</th>
        <td mat-cell *matCellDef="let element">{{ element.grade }}</td>
      </ng-container>

      <!-- Classroom Column -->
      <ng-container matColumnDef="classRoom">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Classroom</th>
        <td mat-cell *matCellDef="let element">{{ element.classRoom }}</td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" (click)="openEditDialog(element)" matTooltip="Edit">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteTimetable(element.id)" matTooltip="Delete">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Row shown when there is no matching data -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="9">
          <div style="text-align: center; padding: 20px;">
            <mat-icon style="font-size: 48px; color: rgba(0,0,0,0.3);">schedule</mat-icon>
            <p style="margin: 10px 0; color: rgba(0,0,0,0.6);">
              {{ selectedTeacher ? 'No timetable entries found for ' + selectedTeacher.fullName : 'No timetable entries found' }}
            </p>
          </div>
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page"></mat-paginator>
  </div>
</div>